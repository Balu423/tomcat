#####################################################################
Recreate Agents
#####################################################################
Replace Swarm Agent
https://github.com/weaveworks/guides/blob/d6c3b28061d40774818734dee915fd829b93e6bf/weave-and-docker-platform/scripts/3-replace-swarm-agents.sh
#####################################################################

# set environment
docker-machine env --swarm swarm-master && \
eval "$(docker-machine env --swarm swarm-master)"

DOCKER_SWARM_CREATE=${DOCKER_SWARM_CREATE:-"curl -XPOST https://discovery-stage.hub.docker.com/v1/clusters"} && \
swarm_dicovery_token="$(${DOCKER_SWARM_CREATE})" && \
echo ${swarm_dicovery_token}

#####################################################################
DOCKER_CLIENT_ARGS="$(docker-machine config swarm-node-01)" && \
weave_proxy_endpoint="$(docker-machine ip swarm-node-01):12375" && \
docker ${DOCKER_CLIENT_ARGS} rm -f swarm-agent && \
docker ${DOCKER_CLIENT_ARGS} run \
  -d \
  --restart=always \
  --name=swarm-agent \
  swarm join \
  --addr "${weave_proxy_endpoint}" \
  "token://${swarm_dicovery_token}"

#####################################################################
DOCKER_CLIENT_ARGS="$(docker-machine config swarm-node-02)" && \
weave_proxy_endpoint="$(docker-machine ip swarm-node-02):12375" && \
docker ${DOCKER_CLIENT_ARGS} rm -f swarm-agent && \
docker ${DOCKER_CLIENT_ARGS} run \
  -d \
  --restart=always \
  --name=swarm-agent \
  swarm join \
  --addr "${weave_proxy_endpoint}" \
  "token://${swarm_dicovery_token}"

#####################################################################
DOCKER_CLIENT_ARGS="$(docker-machine config swarm-node-03)" && \
weave_proxy_endpoint="$(docker-machine ip swarm-node-03):12375" && \
docker ${DOCKER_CLIENT_ARGS} rm -f swarm-agent && \
docker ${DOCKER_CLIENT_ARGS} run \
  -d \
  --restart=always \
  --name=swarm-agent \
  swarm join \
  --addr "${weave_proxy_endpoint}" \
  "token://${swarm_dicovery_token}"

#####################################################################
DOCKER_CLIENT_ARGS="$(docker-machine config swarm-node-04)" && \
weave_proxy_endpoint="$(docker-machine ip swarm-node-04):12375" && \
docker ${DOCKER_CLIENT_ARGS} rm -f swarm-agent && \
docker ${DOCKER_CLIENT_ARGS} run \
  -d \
  --restart=always \
  --name=swarm-agent \
  swarm join \
  --addr "${weave_proxy_endpoint}" \
  "token://${swarm_dicovery_token}"

#####################################################################
DOCKER_CLIENT_ARGS="$(docker-machine config swarm-master)" && \
weave_proxy_endpoint="$(docker-machine ip swarm-master):12375" && \
docker ${DOCKER_CLIENT_ARGS} rm -f swarm-agent && \
docker ${DOCKER_CLIENT_ARGS} run \
  -d \
  --restart=always \
  --name=swarm-agent \
  swarm join \
  --addr "${weave_proxy_endpoint}" \
  "token://${swarm_dicovery_token}"

swarm_master_args_fmt="\
  -d \
  --restart=always \
  --name={{.Name}} \
  -p 3376:3376 \
  {{range .HostConfig.Binds}}-v {{.}} {{end}} \
  swarm{{range .Args}} {{.}}{{end}} \
" && \
echo ${swarm_master_args} && \
swarm_master_args=$(docker ${DOCKER_CLIENT_ARGS} inspect \
  --format="${swarm_master_args_fmt}" \
  swarm-agent-master \
  | sed "s|\(token://\)[[:alnum:]]*|\1${swarm_dicovery_token}|") && \
echo ${swarm_master_args}

docker ${DOCKER_CLIENT_ARGS} rm -f swarm-agent-master && \
docker ${DOCKER_CLIENT_ARGS} run ${swarm_master_args}

#####################################################################
docker run --rm swarm list token://$swarm_dicovery_token
docker info


